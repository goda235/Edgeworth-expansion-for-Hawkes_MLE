######  Hawkes Simulation ###### 

par(mfrow=c(2,1),ps = 15,mar=c(4.3,4.5,2,1))

set.seed(0)

########################################################################################################################
########################################################################################################################
########################################################################################################################
params <- c(0.1, 0.5, 0.55, 0) #(mu, alpha, beta, x)
t_max <- 300

########################################################################################################################
########################################################################################################################
########################################################################################################################

#path of N_t
simulate_uni_hawkes <- function(params, t_max){
  mu     <- params[1]
  alpha  <- params[2]
  beta   <- params[3]
  x <- params[4]
  arrivals <- 0 #t=0
  s <- 0 #interarrival time
  t <- 0 #jump time
  lambda_star <- mu+x #start point of lambda
  D <- 1+(beta*log(runif(1)))/(lambda_star-mu)
  if(D>=0){
      s <- min(-log(D)/beta,-log(runif(1))/mu)
    }else{
      s<- -log(runif(1))/mu
    }
  t <- s
  lambda <- mu + x*exp(-beta*s) + alpha #new value of lambda
  arrivals<- c(arrivals,t)
  while(t < t_max) {
    D <- 1+(beta*log(runif(1)))/(lambda - mu)
    if(D>=0){
      s <- min(-log(D)/beta,-log(runif(1))/mu)
    }else{
      s<- -log(runif(1))/mu
    }
    lambda <- mu + (lambda-mu)*exp(-beta*s) + alpha
    t <- t + s
    if(t < t_max){
      arrivals <- c(arrivals,t)}
    }
  return(c(arrivals,t_max))
}

########################################################################################################################
########################################################################################################################
########################################################################################################################


#set.seed(123)
t <- simulate_uni_hawkes(params, t_max)
N <- c(0:(length(t)-2),length(t)-2)

########################################################################################################################
########################################################################################################################
########################################################################################################################

plot(t,N, type = "s", col = "red",lwd = 2
     ,xlab="t", ylab=expression(N[t]))

########################################################################################################################
########################################################################################################################
########################################################################################################################


#path of intensity
intensity <- function(params, arrivals, delta){
  mu     <- params[1]
  alpha  <- params[2]
  beta   <- params[3]
  x <- params[4]
  lambda <- mu+x
  t <- 0
  result <- lambda
  for(i in 1:(length(arrivals)-1)){
    x <- seq(arrivals[i], arrivals[i+1], by = delta)
    t <- c(t, x)
    result <-c(result, sapply(x, function(s){
      mu + (lambda-mu)*exp(-beta*(s-arrivals[i]))
    }))
    lambda <- mu + (lambda-mu)*exp(-beta*(arrivals[i+1]-arrivals[i])) + alpha
  }
  return(data.frame(t,result))
}

########################################################################################################################
########################################################################################################################
########################################################################################################################

n<-10000
delta <- t_max/n
intensity <- intensity(params, t, delta)
plot(intensity, type = "l", col = "red",lwd = 2
     ,xlab="t", ylab=expression(lambda[t]),ylim=c(0,max(intensity[2])))

segments(0, params[1], t_max, params[1], col="blue",lty=2,ylim=c(0,max(intensity[2])))
